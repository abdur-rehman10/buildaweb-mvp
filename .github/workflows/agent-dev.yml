name: Agent / Dev (Codex) v2

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to implement"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  codex-dev:
    if: |
      (github.event_name == 'issues' && github.event.label.name == 'agent:dev') ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest

    env:
      CODEX_QUIET_MODE: "1"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate OpenAI API key
        env:
          RAW_OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          if [ -z "${RAW_OPENAI_API_KEY:-}" ]; then
            echo "::error::OPENAI_API_KEY is empty in this run. Check repository secret availability for this workflow trigger."
            exit 1
          fi

          SANITIZED_KEY="$(printf '%s' "$RAW_OPENAI_API_KEY" | tr -d '\r\n')"
          if [ -z "$SANITIZED_KEY" ]; then
            echo "::error::OPENAI_API_KEY resolved to an empty value after newline trimming."
            exit 1
          fi

          if [ "$SANITIZED_KEY" != "$RAW_OPENAI_API_KEY" ]; then
            echo "::warning::OPENAI_API_KEY contained newline characters; trimmed for this run."
          fi

          echo "::add-mask::$SANITIZED_KEY"
          echo "OPENAI_API_KEY=$SANITIZED_KEY" >> "$GITHUB_ENV"

          HTTP_CODE="$(curl -sS -o /tmp/openai_models_check.json -w '%{http_code}' \
            -H "Authorization: Bearer $SANITIZED_KEY" \
            https://api.openai.com/v1/models)"

          if [ "$HTTP_CODE" = "401" ]; then
            echo "::error::OpenAI auth failed with HTTP 401. Store only the raw API key in OPENAI_API_KEY (no quotes, no OPENAI_API_KEY= prefix)."
            cat /tmp/openai_models_check.json
            exit 1
          fi

          if [[ ! "$HTTP_CODE" =~ ^[0-9]{3}$ ]]; then
            echo "::error::Unexpected OpenAI preflight response code: '$HTTP_CODE'"
            exit 1
          fi

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::warning::OpenAI preflight returned HTTP $HTTP_CODE. Continuing because only 401 is treated as a hard auth failure."
          fi

      - name: Assert OpenAI key is available for Codex
        run: |
          set -euo pipefail
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "::error::OPENAI_API_KEY is missing before Codex execution."
            exit 1
          fi
          echo "OPENAI_API_KEY length: ${#OPENAI_API_KEY}"

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Determine issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RAW="${{ inputs.issue_number }}"
          else
            RAW="${{ github.event.issue.number }}"
          fi

          NUM="$(echo "$RAW" | tr -cd '0-9')"
          if [ -z "$NUM" ]; then
            echo "Invalid or missing issue number: '$RAW'"
            exit 1
          fi

          echo "num=$NUM" >> "$GITHUB_OUTPUT"

      - name: Fetch issue title/body
        id: issue_data
        uses: actions/github-script@v7
        with:
          script: |
            const n = Number("${{ steps.issue.outputs.num }}");
            const { data } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: n,
            });
            core.setOutput("title", data.title || "");
            core.setOutput("body", data.body || "");
            core.setOutput("url", data.html_url || "");

      - name: Codex implement
        uses: openai/codex-action@main
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: workspace-write
          prompt: |
            Open and follow CODEX_PROMPT.md, AGENTS.md, and PLAN.MD.

            Implement GitHub issue #${{ steps.issue.outputs.num }}: ${{ steps.issue_data.outputs.title }}
            Issue link: ${{ steps.issue_data.outputs.url }}

            Requirements (issue body):
            ${{ steps.issue_data.outputs.body }}

            Constraints:
            - Keep changes minimal and scoped to the issue.
            - Update/add tests if needed.
            - Run relevant tests and ensure they pass.

            Deliverable:
            - Code changes committed on this branch.

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          commit-message: "feat(issue-${{ steps.issue.outputs.num }}): implement issue updates"
          base: main
          branch: agent/dev-${{ steps.issue.outputs.num }}
          title: "Agent Dev: #${{ steps.issue.outputs.num }} â€” ${{ steps.issue_data.outputs.title }}"
          body: |
            Auto-generated by Codex from issue #${{ steps.issue.outputs.num }}.
            Source: ${{ steps.issue_data.outputs.url }}
