name: Agent / QA Auto-fix (Codex)

on:
  workflow_run:
    workflows: ["QA"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      FAILED_RUN_URL: ${{ github.event.workflow_run.html_url }}
      FAILED_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
      FAILED_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}

    steps:
      - name: Checkout failing SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ env.FAILED_HEAD_SHA }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps (API + WEB)
        run: |
          corepack enable
          pnpm --dir apps/api install --frozen-lockfile
          pnpm --dir apps/web install --frozen-lockfile

      - name: Run Codex to fix QA failure
        uses: openai/codex-action@main
        with:
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are fixing a CI failure from the "QA" workflow.
            Failed run: ${{ env.FAILED_RUN_URL }}
            Branch: ${{ env.FAILED_HEAD_BRANCH }}
            SHA: ${{ env.FAILED_HEAD_SHA }}

            Do the minimal change needed to make QA pass.
            Run tests/builds locally in this runner as needed.
            Do not refactor unrelated code.
          codex_args: '["--config","sandbox_mode=\"workspace-write\""]'

      - name: Verify QA locally
        run: |
          pnpm --dir apps/api test
          pnpm --dir apps/web test --if-present

      - name: Create PR with fixes
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "fix(ci): auto-fix QA failure via Codex"
          branch: codex/qa-autofix-${{ github.event.workflow_run.run_id }}
          base: ${{ env.FAILED_HEAD_BRANCH }}
          title: "QA Auto-fix via Codex"
          body: |
            Codex generated this PR after QA failed.
            Failed run: ${{ env.FAILED_RUN_URL }}
            Base branch: `${{ env.FAILED_HEAD_BRANCH }}`
