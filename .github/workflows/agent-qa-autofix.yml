name: Agent / QA Auto-fix (Codex)

on:
  workflow_run:
    workflows: ["QA"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      qa_run_id:
        description: "QA workflow run ID to replay for autofix testing"
        required: true
        type: string
      create_pr:
        description: "Create PR from autofix changes (false = dry run)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Resolve QA run context
        id: qa_context
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const eventName = context.eventName;
            let run;

            if (eventName === "workflow_run") {
              run = context.payload.workflow_run;
            } else {
              const rawRunId = "${{ inputs.qa_run_id }}".trim();
              const runId = Number(rawRunId);
              if (!Number.isInteger(runId) || runId <= 0) {
                core.setFailed(`Invalid qa_run_id: '${rawRunId}'. Provide a numeric QA run ID.`);
                return;
              }

              const { data } = await github.rest.actions.getWorkflowRun({
                owner,
                repo,
                run_id: runId,
              });
              run = data;
            }

            if (!run) {
              core.setFailed("Could not resolve QA run context.");
              return;
            }

            if (run.name !== "QA") {
              core.setFailed(`Run #${run.id} is '${run.name}', expected 'QA'.`);
              return;
            }

            if (!run.head_sha || !run.head_branch) {
              core.setFailed(`Run #${run.id} is missing head SHA or head branch.`);
              return;
            }

            const shouldCreatePr = eventName === "workflow_run"
              ? true
              : "${{ inputs.create_pr }}".toLowerCase() === "true";

            if (eventName === "workflow_dispatch" && run.conclusion !== "failure") {
              core.warning(
                `QA run #${run.id} conclusion is '${run.conclusion}'. Codex may have nothing to fix.`,
              );
            }

            core.setOutput("run_id", String(run.id));
            core.setOutput("run_url", run.html_url || "");
            core.setOutput("head_branch", run.head_branch);
            core.setOutput("head_sha", run.head_sha);
            core.setOutput("conclusion", run.conclusion || "");
            core.setOutput("should_create_pr", shouldCreatePr ? "true" : "false");

      - name: Checkout failing SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.qa_context.outputs.head_sha }}
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.0
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: |
            apps/api/pnpm-lock.yaml
            apps/web/pnpm-lock.yaml

      - name: Install deps (API + WEB)
        env:
          NODE_ENV: development
        run: |
          pnpm --dir apps/api install --frozen-lockfile --prod=false
          pnpm --dir apps/web install --frozen-lockfile --prod=false

      - name: Run Codex to fix QA failure
        uses: openai/codex-action@main
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are fixing a CI failure from the "QA" workflow.
            Failed run: ${{ steps.qa_context.outputs.run_url }}
            Branch: ${{ steps.qa_context.outputs.head_branch }}
            SHA: ${{ steps.qa_context.outputs.head_sha }}

            Do the minimal change needed to make QA pass.
            Run tests/builds locally in this runner as needed.
            Do not refactor unrelated code.
          codex-args: '["--config","sandbox_mode=\"workspace-write\""]'

      - name: Verify QA locally
        run: |
          pnpm --dir apps/api exec jest --version
          pnpm --dir apps/api test
          pnpm --dir apps/web test --if-present

      - name: Create PR with fixes
        if: ${{ steps.qa_context.outputs.should_create_pr == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token != '' && github.token || secrets.GH_BOT_TOKEN }}
          commit-message: "fix(ci): auto-fix QA failure via Codex"
          branch: codex/qa-autofix-${{ steps.qa_context.outputs.run_id }}
          base: ${{ steps.qa_context.outputs.head_branch }}
          title: "QA Auto-fix via Codex"
          body: |
            Codex generated this PR after QA failed.
            Failed run: ${{ steps.qa_context.outputs.run_url }}
            Base branch: `${{ steps.qa_context.outputs.head_branch }}`

      - name: Dry-run summary
        if: ${{ steps.qa_context.outputs.should_create_pr != 'true' }}
        run: |
          echo "Workflow dispatch dry-run mode: PR creation disabled."
          echo "Resolved QA run: ${{ steps.qa_context.outputs.run_id }}"
