name: Agent / Dev (Codex)

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to implement"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  codex-dev:
    if: |
      (github.event_name == 'issues' && github.event.label.name == 'agent:dev') ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      CODEX_QUIET_MODE: "1"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RAW="${{ inputs.issue_number }}"
          else
            RAW="${{ github.event.issue.number }}"
          fi

          echo "raw_issue_number=$RAW"
          # allow "47" or "#47" etc.
          NUM="$(echo "$RAW" | tr -cd '0-9')"

          if [ -z "$NUM" ]; then
            echo "Invalid or missing issue number: '$RAW'"
            exit 1
          fi

          echo "num=$NUM" >> "$GITHUB_OUTPUT"

      - name: Debug resolved issue number
        run: |
          echo "event=${{ github.event_name }}"
          echo "resolved=${{ steps.issue.outputs.num }}"

      - name: Fetch issue title/body
        id: issue_data
        uses: actions/github-script@v7
        with:
          script: |
            const n = Number("${{ steps.issue.outputs.num }}");
            const { data } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: n,
            });
            core.setOutput("title", data.title || "");
            core.setOutput("body", data.body || "");
            core.setOutput("url", data.html_url || "");

      - name: Install Codex CLI
        run: npm i -g @openai/codex

      - name: Create working branch
        id: br
        run: |
          BR="agent/dev-${{ steps.issue.outputs.num }}-${{ github.run_id }}"
          echo "branch=$BR" >> $GITHUB_OUTPUT
          git checkout -b "$BR"

      - name: Codex implement & commit
        run: |
          set -e
          codex --approval-mode full-auto --no-terminal --quiet \
            "Open and follow CODEX_PROMPT.md, AGENTS.md, and PLAN.MD.
             Implement GitHub issue #${{ steps.issue.outputs.num }}: ${{ steps.issue_data.outputs.title }}.
             Issue link: ${{ steps.issue_data.outputs.url }}
             Requirements (issue body):
             ${{ steps.issue_data.outputs.body }}
             Constraints:
             - Keep changes minimal and scoped to the issue.
             - Update/add tests if needed.
             - Run relevant tests/commands and ensure they pass.
             Deliverable:
             - Code changes committed on this branch."

          git add -A
          git commit -m "feat(issue-${{ steps.issue.outputs.num }}): ${{ steps.issue_data.outputs.title }}" || echo "No changes to commit."

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          base: main
          branch: ${{ steps.br.outputs.branch }}
          title: "Agent Dev: #${{ steps.issue.outputs.num }} â€” ${{ steps.issue_data.outputs.title }}"
          body: |
            Auto-generated by Codex from issue #${{ steps.issue.outputs.num }}.
            Source: ${{ steps.issue_data.outputs.url }}
