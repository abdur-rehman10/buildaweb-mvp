{
  auto_https off
}

:80 {
  encode zstd gzip

  # Public media proxy (MinIO via app host)
  handle_path /media/* {
    reverse_proxy minio:9000
  }

  # Published sites (path-based)
  handle /p/* {
    rewrite * /api/v1{uri}
    reverse_proxy api:4000
  }

  # API under /api/* (keep /api prefix intact)
  handle /api/* {
    reverse_proxy api:4000
  }

  # Web app (React build)
  handle {
    reverse_proxy web:80
  }
}
